<html>
<head>
    <title>Родословная</title>
    <meta charset="utf-8">    
    <link rel="stylesheet" type="text/css" href="/static/semantic.min.css">
    <style>
html{
    height: 100%;
}
body {
    position:absolute; top:0; bottom:0; right:0; left:0;
}
#output svg {
    width: 100%;
    height: 100%;
}
main{
    height: calc(100% - 4em);
    width: 100%
}
.toprightattached
{
    position: absolute;
    top     : -15px;
    right   : -15px
}
    </style>
</head>
<body>
    <nav class="ui menu inverted">
        <div class="header item">Родословная</div>
        <div class="ui search selectable dropdown icon item version-selector">
            <i class="dropdown icon"></i>
            <input type="hidden">
            <input type="text" class="search">
            <div class="default text">Выберите версию</div>
        </div>
        <a class="active item"><i class="eye icon"></i>Просмотр</a>
        <a id="ch_person" class="item"><i class="user icon"></i>Изменение персоналий</a>
        <a class="item"><i class="users icon"></i>Изменение семей</a>
        <a class="item"><i class="sitemap icon"></i>Изменение связей</a>
    </nav>
    <div class="ui active dimmer">
        <div class="ui loader"></div>
    </div>
    <main class="ui fluid container" id="output">
        
    </main>
    <script src="static/jquery-2.2.0.min.js"></script>
    <script src="static/semantic.js"></script>
    <script src="static/viz.js"></script>
    <script src="static/lokijs.min.js"></script>
    <script src="static/svg-pan-zoom.js"></script>
    <script>
function AjaxDBAdapter(){}
AjaxDBAdapter.prototype.loadDatabase = function(dbname, callback) {
  $.ajax("/"+dbname, {
        dataType: "text",
        success: callback,
        error: function(){callback(new Error("There was a problem loading " + dbname + " database"));}
  })
}

AjaxDBAdapter.prototype.saveDatabase = function(dbname, dbstring, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "/db", true);
    xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4)
            if (xhr.status == 200) {
                callback(null);
            }else{
                callback(new Error("An error was encountered saving " + dbname + " database."));
            }
    }
    xhr.send(dbstring);
}
function create(ldb){
    var persons = ldb.getCollection('persons');
    var families = ldb.getCollection('families');
    graph = 'digraph G{\n'+
            ' graph[splines=polyline]\n'+
            ' node[shape="record"]\n'+
            persons.mapReduce(
                function (pers){
                    return '"p' + pers.$loki +'"[label=" '+
                        pers.families.map(function(v,i){if(i!=0 ){return "("+v+")";};return v;}).join("")+"\\n"+
                        pers.names.map(function(v,i){if(i!=0 ){return "("+v+")";};return v;}).join("")+"\\n"+
                        pers.snames.map(function(v,i){if(i!=0 ){return "("+v+")";};return v;}).join("")+"\\n"+
                        '('+pers.birth+'-'+pers.death+' гг)", id="p' + pers.$loki +'"];\n';
                },
                function (arr){
                    return arr.join("");
                }
            )+
            families.mapReduce(
                function (f){
                    return  '{ '+f.partners.map(function(p){return '"p' + p +'"';}).join()+'}->"f'+f.$loki+'"\n'+
                            '"f'+f.$loki+'"[shape="point", id="f'+f.$loki+'"]\n'+
                            '"f'+f.$loki+'"->{'+f.children.map(function(p){return '"p' + p +'"';})+'}\n'
                },
                function (arr){
                    return arr.join("");
                }
            )+
            '}';
    s = Viz(graph).replace(
        "<svg",
        '<svg id="output-svg" preserveAspectRatio="xMinYMin meet" class="ui image fluid" '
        );
    $("#output").append(s);
    svgPanZoom("#output-svg");
    $("#output-svg")
        .attr("width","100%")
        .attr("height", "100%")
        .contextmenu(function(){return false;});
    $('#output').find(".node").click(function(ev){
        console.log($(ev.currentTarget).attr("id"));
    })
}
function send_json(url, dat){
    var xhr = new XMLHttpRequest();
    xhr.open("POST", url, true);
    xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
    xhr.send(dat);
}
function get_json(url, cb, ecb){
    $.ajax(url, {
        dataType: "json",
        success: cb,
        error: ecb
    })
}
function add_with_animaion(sel, sing, plur, value){
    $(sel).append("<p>&nbsp;</p>"); 
    var data = $(
        '<div class="ui input">'+
        ' <input placeholder="'+sing+'" type="text">'+
        ' <button class="ui toprightattached circular mini negative icon button">'+
        ' <i class="icon minus"></i>'+
        '</button>').hide(); 
    $(sel).append(data); data.slideDown(); 
    $(sel+" div button.ui.negative")
       .off("click")
       .click(del_click_handler(sing,plur))    
    l = $(sel).find("div").length
    if (l==1){
        $(sel).find("h3")
      .text(sing)
    }else{
        $(sel).find("h3")
          .text(plur)
    }
    if(value){
        data.find("input").attr("value", value);
    }
}
function del_click_handler(sing,plur){
return  function(){
    pp = $(this).parent().parent()
    l = pp.find("div").length
    if (l==2){
        pp.find("h3")
      .text(sing)
    }else{
        pp.find("h3")
          .text(plur)
    }
    $(this).parent()
        .slideUp(400, function(){
            a = $(this)
            a.prev().remove()
            a[0].remove();
        })
}
}
function multifield_input(sel, cls, hsingular, hplural, arr){
    arr= arr || [];
    var ndiv = $(
        '<div class="segment '+cls+'">'+
        ' <h3>'+((arr.length>1) ? hplural : hsingular)+'</h3>'+
        ' <div class="ui input">'+
        '  <input type="text" placeholder="'+hsingular+'" value="">'+
        '  <button class="ui toprightattached circular mini positive icon button">'+
        '   <i class="icon plus"></i>'+
        '  </button>'+
        ' </div>'+
        '</div>'
    );
    ndiv.find("button").click(function(){
            add_with_animaion(sel+" .segment."+cls, hsingular, hplural)
        });
    if(arr.length>0){
        ndiv.find("input").attr("value", arr[0]);
    }
    $(sel).append(ndiv)
    for (i=1;i<arr.length;i++){
        add_with_animaion(sel+" .segment."+cls, hsingular, hplural, arr[i]);
    }
}
function fio_inputs(sel, fams, nams, snams){
    fams = fams || [];
    nams = nams || [];
    snams = snams || [];
    $(sel).append('<div class="ui three column middle aligned grid fio"></div>')
    multifield_input(sel+" .fio", "fam", "Фамилия", "Фамилии", fams);
    multifield_input(sel+" .fio", "nam", "Имя", "Имена", nams);
    multifield_input(sel+" .fio", "snam", "Отчество", "Отчества", snams);
}
function edit_person(sel, pers){
    pers_def = {
            id: -1,
            families: [],
            names: [],
            snames: [],
            gender: "Женский",
            birth: "??",
            death: "??"
        }
    pers = $.extend(true, pers_def, pers)
    idd = pers.id;
    var ndiv = $(
      '<div id="pers'+idd+'" class="ui modal">'+
      ' <div class="icon header"><i class="edit icon"></i>Изменить человека</div>'+
      ' <div class="content"></div>'+
      ' <div class="actions">'+
      '  <div class="two fluid ui inverted buttons">'+
      '   <div class="ui red deny button"><i class="remove icon"></i>Отменить</div>'+
      '   <div class="ui green positive right button"><i class="checkmark icon"></i>Сохранить</div>'+
      '  </div>'+
      ' </div>'+
      '</div>'
    )
    $(sel).append(ndiv);
    fio_inputs("#pers"+idd+" .content", pers.families, pers.names, pers.snames);
    ndiv.find(".content").append('<p>&nbsp;</p>')
    var gender = $(
        '<div class="segment">'+
        ' <h3>Пол</h3>'+
        ' <div class="ui label fluid selection dropdown">'+
        '  <input name="gender" type="hidden">'+
        '  <i class="dropdown icon"></i>'+
        '  <div class="default text">Пол</div>'+
        '  <div class="menu">'+
        '   <div class="item" data-value="мужской"><i class="male icon"></i>Мужской</div>'+
        '   <div class="item" data-value="женский"><i class="female icon"></i>Женский</div>'+
        '  </div>'+
        ' </div>'+
        '</div>'
    );
    ndiv.find(".content").append(gender);
    gender.find('.dropdown').dropdown().dropdown("set selected", pers.gender);
    var bd = $('<p>&nbsp;</p>'+
        '<div class="ui top attached tabular menu">'+
        '  <a class="item active" data-tab="birth">Рождение</a>'+
        '  <a class="item" data-tab="death">Смерть</a>'+
        '</div>'+
        '<div class="ui bottom attached tab segment active" data-tab="birth">'+
        ' <div class="segment">'+
        '  <h3>Дата</h3>'+
        '  <div class="ui input">'+
        '   <input type="text" placeholder="Дата рождения" class="birth" value="">'+
        '  </div>'+
        ' </div>'+
        '</div>'+
        '<div class="ui bottom attached tab segment" data-tab="death">'+
        ' <div class="segment">'+
        '  <h3>Дата</h3>'+
        '  <div class="ui input">'+
        '   <input type="text" placeholder="Дата смерти" class="death" value="">'+
        '  </div>'+
        ' </div>'+
        '</div>'
        );
    ndiv.find(".content").append(bd)
    bd.find('.item').tab()
    var birth = bd.find('.birth'),
        death = bd.find('.death');
    birth.attr("value", pers.birth);
    death.attr("value", pers.death);
    ndiv.modal({closable: false,
                    detachable: false,
                    onHidden: function(){
                        ndiv.remove()
                    }
            })
    return ndiv
}
$(document).ready(function() {
    //('main').height($('body').height() - $('.ui.menu').height())
    $('.ui.menu a.item').on('click', function() {
        $(this)
            .addClass('active')
            .siblings()
            .removeClass('active');
          });
    $('.version-selector').dropdown({
        debug:true,
        saveRemoteData: false,
        apiSettings: {
            url: '/dbs',
            on: true,
            cache: false,
            debug: true
        }
    });
    var db = new loki("db-latest", {adapter: new AjaxDBAdapter()});
    var persons = db.addCollection('persons');
    var families = db.addCollection('families');
    persons.insert({ families:['Прокофьев'], names:['Иван'], snames:['Прокофьевич'], gender:'мужской', birth:'1861', death:'1949'});
    persons.insert({ families:['Прокофьева'], names:['Акелина'], snames:['Ивановна'], gender:'женский', birth:'??', death:'??'});
    persons.insert({ families:['Прокофьева'], names:['Екатерина'], snames:['Ивановна'], gender:'женский', birth:'??', death:'??'});
    persons.insert({ families:['Смирнов'], names:['Степан'], snames:['??'], gender:'мужской', birth:'??', death:'??'});
    persons.insert({ families:['Смирнова', 'Иванова'], names:['Мария'], snames:['Ивановна'], gender:'женский', birth:'04.04.1892', death:'30.09.1970'});
    families.insert({partners:[1, 2 ], children:[5]});
    families.insert({partners:[3, 2 ], children:[]});
    families.insert({partners:[4, 5 ], children:[]});
    db.saveDatabase(function(){db.loadDatabase();});
    
    create(db);
    $("#ch_person").on('click', function(){
        var newdiv = edit_person("main", 
             {families:["Иванов", "Петров"], 
              names:["Иван"],
              snames:["Иванович"],
              id:1,
              gender: "Женский"
             })
            .modal('show');
    });
    $(".ui.active.dimmer").removeClass("active").remove()
});
    </script>
</body>
</html>
